<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-|
Module      : Server
Description : This module represents a game server for connect four network game.

Module provides an only function that starts gameserver. Server makes two connections with players, and then asynchronously listens on both. If any of the players sends data to server, it is proccessed in a main thread and response is returned to the sender via same conncetion.
-}</span><span>
</span><span id="line-7"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Server</span><span class="hs-special">(</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><a href="Server.html#runServer"><span class="hs-identifier">runServer</span></a></span><span>
</span><span id="line-9"></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.Socket</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.IO</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Class</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.State.Strict</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Fix</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">fix</span></span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GameLogics.html"><span class="hs-identifier">GameLogics</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Text.Read</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">readMaybe</span></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-22"></span><span>
</span><span id="line-23"></span><span class="hs-keyword">type</span><span> </span><span id="Msg"><span class="annot"><a href="Server.html#Msg"><span class="hs-identifier hs-var">Msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GameLogics.html#Player"><span class="hs-identifier hs-type">Player</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">type</span><span> </span><span id="GameState"><span class="annot"><a href="Server.html#GameState"><span class="hs-identifier hs-var">GameState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="GameLogics.html#Position"><span class="hs-identifier hs-type">Position</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span class="hs-comment">-- | Main function of the module. Listens on given address for two players (first connected is given red team to play for, second - yellow) and then starts game loop.</span><span>
</span><span id="line-27"></span><span class="annot"><a href="Server.html#runServer"><span class="hs-identifier hs-type">runServer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-comment">-- ^ port to listen on for players</span><span>
</span><span id="line-28"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span id="runServer"><span class="annot"><span class="annottext">runServer :: String -&gt; IO ()
</span><a href="Server.html#runServer"><span class="hs-identifier hs-var hs-var">runServer</span></a></span></span><span> </span><span id="local-6989586621679059203"><span class="annot"><span class="annottext">port :: String
</span><a href="#local-6989586621679059203"><span class="hs-identifier hs-var">port</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-30"></span><span>    </span><span id="local-6989586621679059202"><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679059202"><span class="hs-identifier hs-var">sock</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Family -&gt; SocketType -&gt; ProtocolNumber -&gt; IO Socket
</span><span class="hs-identifier hs-var">socket</span></span><span> </span><span class="annot"><span class="annottext">Family
</span><span class="hs-identifier hs-var">AF_INET</span></span><span> </span><span class="annot"><span class="annottext">SocketType
</span><span class="hs-identifier hs-var">Stream</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span>
</span><span id="line-31"></span><span>    </span><span class="annot"><span class="annottext">Socket -&gt; SocketOption -&gt; Int -&gt; IO ()
</span><span class="hs-identifier hs-var">setSocketOption</span></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679059202"><span class="hs-identifier hs-var">sock</span></a></span><span> </span><span class="annot"><span class="annottext">SocketOption
</span><span class="hs-identifier hs-var">ReuseAddr</span></span><span> </span><span class="annot"><span class="hs-number">1</span></span><span>
</span><span id="line-32"></span><span>    </span><span id="local-6989586621679059196"><span class="annot"><span class="annottext">[AddrInfo]
</span><a href="#local-6989586621679059196"><span class="hs-identifier hs-var">addrinfos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe AddrInfo -&gt; Maybe String -&gt; Maybe String -&gt; IO [AddrInfo]
</span><span class="hs-identifier hs-var">getAddrInfo</span></span><span>
</span><span id="line-33"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AddrInfo -&gt; Maybe AddrInfo
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AddrInfo
</span><span class="hs-identifier hs-var">defaultHints</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">addrFlags :: [AddrInfoFlag]
</span><span class="hs-identifier hs-var">addrFlags</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">AddrInfoFlag
</span><span class="hs-identifier hs-var">AI_PASSIVE</span></span><span class="hs-special">]</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span>                    </span><span class="annot"><span class="annottext">Maybe String
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Maybe String
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679059203"><span class="hs-identifier hs-var">port</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span>    </span><span class="annot"><span class="annottext">Socket -&gt; SockAddr -&gt; IO ()
</span><span class="hs-identifier hs-var">bind</span></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679059202"><span class="hs-identifier hs-var">sock</span></a></span><span> </span><span class="annot"><span class="annottext">(SockAddr -&gt; IO ()) -&gt; SockAddr -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">AddrInfo -&gt; SockAddr
</span><span class="hs-identifier hs-var hs-var">addrAddress</span></span><span> </span><span class="annot"><span class="annottext">(AddrInfo -&gt; SockAddr) -&gt; AddrInfo -&gt; SockAddr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[AddrInfo] -&gt; AddrInfo
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">head</span></span><span> </span><span class="annot"><span class="annottext">[AddrInfo]
</span><a href="#local-6989586621679059196"><span class="hs-identifier hs-var">addrinfos</span></a></span><span>
</span><span id="line-36"></span><span>    </span><span class="annot"><span class="annottext">Socket -&gt; Int -&gt; IO ()
</span><span class="hs-identifier hs-var">listen</span></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679059202"><span class="hs-identifier hs-var">sock</span></a></span><span> </span><span class="annot"><span class="hs-number">2</span></span><span>
</span><span id="line-37"></span><span>    </span><span id="local-6989586621679059187"><span class="annot"><span class="annottext">Chan Msg
</span><a href="#local-6989586621679059187"><span class="hs-identifier hs-var">chan</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Chan Msg)
forall a. IO (Chan a)
</span><span class="hs-identifier hs-var">newChan</span></span><span>
</span><span id="line-38"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679059185"><span class="annot"><span class="annottext">sockR :: Socket
</span><a href="#local-6989586621679059185"><span class="hs-identifier hs-var">sockR</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Socket -&gt; IO (Socket, SockAddr)
</span><span class="hs-identifier hs-var">accept</span></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679059202"><span class="hs-identifier hs-var">sock</span></a></span><span>
</span><span id="line-39"></span><span>    </span><span id="local-6989586621679059183"><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059183"><span class="hs-identifier hs-var">hdlR</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Socket -&gt; IO Handle
</span><a href="Server.html#getHandle"><span class="hs-identifier hs-var">getHandle</span></a></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679059185"><span class="hs-identifier hs-var">sockR</span></a></span><span>
</span><span id="line-40"></span><span>    </span><span id="local-6989586621679059181"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679059181"><span class="hs-identifier hs-var">tidR</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ThreadId
</span><span class="hs-identifier hs-var">forkIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Handle -&gt; Player -&gt; Chan Msg -&gt; IO ()
</span><a href="Server.html#runClient"><span class="hs-identifier hs-var">runClient</span></a></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059183"><span class="hs-identifier hs-var">hdlR</span></a></span><span> </span><span class="annot"><span class="annottext">Player
</span><a href="GameLogics.html#R"><span class="hs-identifier hs-var">R</span></a></span><span> </span><span class="annot"><span class="annottext">Chan Msg
</span><a href="#local-6989586621679059187"><span class="hs-identifier hs-var">chan</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679059177"><span class="annot"><span class="annottext">sockY :: Socket
</span><a href="#local-6989586621679059177"><span class="hs-identifier hs-var">sockY</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Socket -&gt; IO (Socket, SockAddr)
</span><span class="hs-identifier hs-var">accept</span></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679059202"><span class="hs-identifier hs-var">sock</span></a></span><span>
</span><span id="line-42"></span><span>    </span><span id="local-6989586621679059176"><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059176"><span class="hs-identifier hs-var">hdlY</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Socket -&gt; IO Handle
</span><a href="Server.html#getHandle"><span class="hs-identifier hs-var">getHandle</span></a></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679059177"><span class="hs-identifier hs-var">sockY</span></a></span><span>
</span><span id="line-43"></span><span>    </span><span id="local-6989586621679059175"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679059175"><span class="hs-identifier hs-var">tidY</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ThreadId
</span><span class="hs-identifier hs-var">forkIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Handle -&gt; Player -&gt; Chan Msg -&gt; IO ()
</span><a href="Server.html#runClient"><span class="hs-identifier hs-var">runClient</span></a></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059176"><span class="hs-identifier hs-var">hdlY</span></a></span><span> </span><span class="annot"><span class="annottext">Player
</span><a href="GameLogics.html#Y"><span class="hs-identifier hs-var">Y</span></a></span><span> </span><span class="annot"><span class="annottext">Chan Msg
</span><a href="#local-6989586621679059187"><span class="hs-identifier hs-var">chan</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span>    </span><span class="annot"><span class="annottext">StateT Position IO () -&gt; Position -&gt; IO Position
forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m s
</span><span class="hs-identifier hs-var">execStateT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Chan Msg -&gt; (Player -&gt; Handle) -&gt; StateT Position IO ()
</span><a href="Server.html#serverLoop"><span class="hs-identifier hs-var">serverLoop</span></a></span><span> </span><span class="annot"><span class="annottext">Chan Msg
</span><a href="#local-6989586621679059187"><span class="hs-identifier hs-var">chan</span></a></span><span> </span><span class="annot"><span class="annottext">((Player -&gt; Handle) -&gt; StateT Position IO ())
-&gt; (Player -&gt; Handle) -&gt; StateT Position IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Player, Handle)] -&gt; Player -&gt; Handle
</span><a href="Server.html#handleForPlayer"><span class="hs-identifier hs-var">handleForPlayer</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Player
</span><a href="GameLogics.html#R"><span class="hs-identifier hs-var">R</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059183"><span class="hs-identifier hs-var">hdlR</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Player
</span><a href="GameLogics.html#Y"><span class="hs-identifier hs-var">Y</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059176"><span class="hs-identifier hs-var">hdlY</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="GameLogics.html#newGame"><span class="hs-identifier hs-var">newGame</span></a></span><span>
</span><span id="line-45"></span><span>    </span><span class="annot"><span class="annottext">Handle -&gt; String -&gt; IO ()
</span><span class="hs-identifier hs-var">hPutStrLn</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059183"><span class="hs-identifier hs-var">hdlR</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Exit&quot;</span></span><span>
</span><span id="line-46"></span><span>    </span><span class="annot"><span class="annottext">Handle -&gt; String -&gt; IO ()
</span><span class="hs-identifier hs-var">hPutStrLn</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059176"><span class="hs-identifier hs-var">hdlY</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Exit&quot;</span></span><span>
</span><span id="line-47"></span><span>    </span><span class="annot"><span class="annottext">ThreadId -&gt; IO ()
</span><span class="hs-identifier hs-var">killThread</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679059181"><span class="hs-identifier hs-var">tidR</span></a></span><span>
</span><span id="line-48"></span><span>    </span><span class="annot"><span class="annottext">ThreadId -&gt; IO ()
</span><span class="hs-identifier hs-var">killThread</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679059175"><span class="hs-identifier hs-var">tidY</span></a></span><span>
</span><span id="line-49"></span><span>    </span><span class="annot"><span class="annottext">Handle -&gt; IO ()
</span><span class="hs-identifier hs-var">hClose</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059183"><span class="hs-identifier hs-var">hdlR</span></a></span><span>
</span><span id="line-50"></span><span>    </span><span class="annot"><span class="annottext">Handle -&gt; IO ()
</span><span class="hs-identifier hs-var">hClose</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059176"><span class="hs-identifier hs-var">hdlY</span></a></span><span>
</span><span id="line-51"></span><span>    </span><span class="annot"><span class="annottext">Socket -&gt; IO ()
</span><span class="hs-identifier hs-var">close</span></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679059185"><span class="hs-identifier hs-var">sockR</span></a></span><span>
</span><span id="line-52"></span><span>    </span><span class="annot"><span class="annottext">Socket -&gt; IO ()
</span><span class="hs-identifier hs-var">close</span></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679059177"><span class="hs-identifier hs-var">sockY</span></a></span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span class="annot"><a href="Server.html#serverLoop"><span class="hs-identifier hs-type">serverLoop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Chan</span></span><span> </span><span class="annot"><a href="Server.html#Msg"><span class="hs-identifier hs-type">Msg</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GameLogics.html#Player"><span class="hs-identifier hs-type">Player</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Server.html#GameState"><span class="hs-identifier hs-type">GameState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span id="serverLoop"><span class="annot"><span class="annottext">serverLoop :: Chan Msg -&gt; (Player -&gt; Handle) -&gt; StateT Position IO ()
</span><a href="Server.html#serverLoop"><span class="hs-identifier hs-var hs-var">serverLoop</span></a></span></span><span> </span><span id="local-6989586621679059165"><span class="annot"><span class="annottext">chan :: Chan Msg
</span><a href="#local-6989586621679059165"><span class="hs-identifier hs-var">chan</span></a></span></span><span> </span><span id="local-6989586621679059164"><span class="annot"><span class="annottext">h4p :: Player -&gt; Handle
</span><a href="#local-6989586621679059164"><span class="hs-identifier hs-var">h4p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-56"></span><span>    </span><span id="local-6989586621679059163"><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679059163"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT Position IO Position
forall (m :: * -&gt; *) s. Monad m =&gt; StateT s m s
</span><span class="hs-identifier hs-var">get</span></span><span>
</span><span id="line-57"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Position -&gt; Result
</span><a href="GameLogics.html#evaluatePosition"><span class="hs-identifier hs-var">evaluatePosition</span></a></span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679059163"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-58"></span><span>        </span><span class="annot"><a href="GameLogics.html#Win"><span class="hs-identifier hs-type">Win</span></a></span><span> </span><span class="annot"><a href="GameLogics.html#R"><span class="hs-identifier hs-type">R</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; StateT Position IO ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; StateT Position IO ()) -&gt; IO () -&gt; StateT Position IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Player -&gt; (Player -&gt; Handle) -&gt; Position -&gt; IO ()
</span><a href="Server.html#tellWin"><span class="hs-identifier hs-var">tellWin</span></a></span><span> </span><span class="annot"><span class="annottext">Player
</span><a href="GameLogics.html#R"><span class="hs-identifier hs-var">R</span></a></span><span>  </span><span class="annot"><span class="annottext">Player -&gt; Handle
</span><a href="#local-6989586621679059164"><span class="hs-identifier hs-var">h4p</span></a></span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679059163"><span class="hs-identifier hs-var">pos</span></a></span><span>
</span><span id="line-59"></span><span>        </span><span class="annot"><a href="GameLogics.html#Win"><span class="hs-identifier hs-type">Win</span></a></span><span> </span><span class="annot"><a href="GameLogics.html#Y"><span class="hs-identifier hs-type">Y</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; StateT Position IO ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; StateT Position IO ()) -&gt; IO () -&gt; StateT Position IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Player -&gt; (Player -&gt; Handle) -&gt; Position -&gt; IO ()
</span><a href="Server.html#tellWin"><span class="hs-identifier hs-var">tellWin</span></a></span><span> </span><span class="annot"><span class="annottext">Player
</span><a href="GameLogics.html#Y"><span class="hs-identifier hs-var">Y</span></a></span><span> </span><span class="annot"><span class="annottext">Player -&gt; Handle
</span><a href="#local-6989586621679059164"><span class="hs-identifier hs-var">h4p</span></a></span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679059163"><span class="hs-identifier hs-var">pos</span></a></span><span>
</span><span id="line-60"></span><span>        </span><span class="annot"><a href="GameLogics.html#Draw"><span class="hs-identifier hs-type">Draw</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; StateT Position IO ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; StateT Position IO ()) -&gt; IO () -&gt; StateT Position IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Player -&gt; Handle) -&gt; Position -&gt; IO ()
</span><a href="Server.html#tellDraw"><span class="hs-identifier hs-var">tellDraw</span></a></span><span> </span><span class="annot"><span class="annottext">Player -&gt; Handle
</span><a href="#local-6989586621679059164"><span class="hs-identifier hs-var">h4p</span></a></span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679059163"><span class="hs-identifier hs-var">pos</span></a></span><span>
</span><span id="line-61"></span><span>        </span><span class="annot"><a href="GameLogics.html#InProgress"><span class="hs-identifier hs-type">InProgress</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-62"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679059154"><span class="annot"><span class="annottext">hdl :: Handle
</span><a href="#local-6989586621679059154"><span class="hs-identifier hs-var hs-var">hdl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Player -&gt; Handle
</span><a href="#local-6989586621679059164"><span class="hs-identifier hs-var">h4p</span></a></span><span> </span><span class="annot"><span class="annottext">(Player -&gt; Handle) -&gt; Player -&gt; Handle
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Position -&gt; Player
</span><a href="GameLogics.html#turn"><span class="hs-identifier hs-var hs-var">turn</span></a></span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679059163"><span class="hs-identifier hs-var">pos</span></a></span><span>
</span><span id="line-63"></span><span>            </span><span class="annot"><span class="annottext">IO () -&gt; StateT Position IO ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; StateT Position IO ()) -&gt; IO () -&gt; StateT Position IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Handle -&gt; Board -&gt; IO ()
forall a. Show a =&gt; Handle -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">hPrint</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059154"><span class="hs-identifier hs-var">hdl</span></a></span><span> </span><span class="annot"><span class="annottext">(Board -&gt; IO ()) -&gt; Board -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Position -&gt; Board
</span><a href="GameLogics.html#board"><span class="hs-identifier hs-var hs-var">board</span></a></span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679059163"><span class="hs-identifier hs-var">pos</span></a></span><span>
</span><span id="line-64"></span><span>            </span><span class="annot"><span class="annottext">Chan Msg -&gt; (Player -&gt; Handle) -&gt; StateT Position IO ()
</span><a href="Server.html#gameIteration"><span class="hs-identifier hs-var">gameIteration</span></a></span><span> </span><span class="annot"><span class="annottext">Chan Msg
</span><a href="#local-6989586621679059165"><span class="hs-identifier hs-var">chan</span></a></span><span> </span><span class="annot"><span class="annottext">Player -&gt; Handle
</span><a href="#local-6989586621679059164"><span class="hs-identifier hs-var">h4p</span></a></span><span>
</span><span id="line-65"></span><span>            </span><span class="annot"><span class="annottext">Chan Msg -&gt; (Player -&gt; Handle) -&gt; StateT Position IO ()
</span><a href="Server.html#serverLoop"><span class="hs-identifier hs-var">serverLoop</span></a></span><span> </span><span class="annot"><span class="annottext">Chan Msg
</span><a href="#local-6989586621679059165"><span class="hs-identifier hs-var">chan</span></a></span><span> </span><span class="annot"><span class="annottext">Player -&gt; Handle
</span><a href="#local-6989586621679059164"><span class="hs-identifier hs-var">h4p</span></a></span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span class="annot"><a href="Server.html#gameIteration"><span class="hs-identifier hs-type">gameIteration</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Chan</span></span><span> </span><span class="annot"><a href="Server.html#Msg"><span class="hs-identifier hs-type">Msg</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GameLogics.html#Player"><span class="hs-identifier hs-type">Player</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Server.html#GameState"><span class="hs-identifier hs-type">GameState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span id="gameIteration"><span class="annot"><span class="annottext">gameIteration :: Chan Msg -&gt; (Player -&gt; Handle) -&gt; StateT Position IO ()
</span><a href="Server.html#gameIteration"><span class="hs-identifier hs-var hs-var">gameIteration</span></a></span></span><span> </span><span id="local-6989586621679059149"><span class="annot"><span class="annottext">chan :: Chan Msg
</span><a href="#local-6989586621679059149"><span class="hs-identifier hs-var">chan</span></a></span></span><span> </span><span id="local-6989586621679059148"><span class="annot"><span class="annottext">h4p :: Player -&gt; Handle
</span><a href="#local-6989586621679059148"><span class="hs-identifier hs-var">h4p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-69"></span><span>    </span><span id="local-6989586621679059147"><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679059147"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT Position IO Position
forall (m :: * -&gt; *) s. Monad m =&gt; StateT s m s
</span><span class="hs-identifier hs-var">get</span></span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679059146"><span class="annot"><span class="annottext">p :: Player
</span><a href="#local-6989586621679059146"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679059145"><span class="annot"><span class="annottext">msg :: String
</span><a href="#local-6989586621679059145"><span class="hs-identifier hs-var">msg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Msg -&gt; StateT Position IO Msg
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(IO Msg -&gt; StateT Position IO Msg)
-&gt; IO Msg -&gt; StateT Position IO Msg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Chan Msg -&gt; IO Msg
forall a. Chan a -&gt; IO a
</span><span class="hs-identifier hs-var">readChan</span></span><span> </span><span class="annot"><span class="annottext">Chan Msg
</span><a href="#local-6989586621679059149"><span class="hs-identifier hs-var">chan</span></a></span><span>
</span><span id="line-71"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679059143"><span class="annot"><span class="annottext">move :: Int
</span><a href="#local-6989586621679059143"><span class="hs-identifier hs-var hs-var">move</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int -&gt; Int
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Maybe Int
forall a. Read a =&gt; String -&gt; Maybe a
</span><span class="hs-identifier hs-var">readMaybe</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679059145"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span>        </span><span id="local-6989586621679059141"><span class="annot"><span class="annottext">hdl :: Handle
</span><a href="#local-6989586621679059141"><span class="hs-identifier hs-var hs-var">hdl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Player -&gt; Handle
</span><a href="#local-6989586621679059148"><span class="hs-identifier hs-var">h4p</span></a></span><span> </span><span class="annot"><span class="annottext">Player
</span><a href="#local-6989586621679059146"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-73"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Player
</span><a href="#local-6989586621679059146"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Player -&gt; Player -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Position -&gt; Player
</span><a href="GameLogics.html#turn"><span class="hs-identifier hs-var hs-var">turn</span></a></span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679059147"><span class="hs-identifier hs-var">pos</span></a></span><span>
</span><span id="line-74"></span><span>        </span><span class="hs-keyword">then</span><span>
</span><span id="line-75"></span><span>            </span><span class="annot"><span class="annottext">IO () -&gt; StateT Position IO ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Handle -&gt; String -&gt; IO ()
</span><span class="hs-identifier hs-var">hPutStrLn</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059141"><span class="hs-identifier hs-var">hdl</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Not your turn!&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StateT Position IO ()
-&gt; StateT Position IO () -&gt; StateT Position IO ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Chan Msg -&gt; (Player -&gt; Handle) -&gt; StateT Position IO ()
</span><a href="Server.html#gameIteration"><span class="hs-identifier hs-var">gameIteration</span></a></span><span> </span><span class="annot"><span class="annottext">Chan Msg
</span><a href="#local-6989586621679059149"><span class="hs-identifier hs-var">chan</span></a></span><span> </span><span class="annot"><span class="annottext">Player -&gt; Handle
</span><a href="#local-6989586621679059148"><span class="hs-identifier hs-var">h4p</span></a></span><span>
</span><span id="line-76"></span><span>        </span><span class="hs-keyword">else</span><span>
</span><span id="line-77"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679059143"><span class="hs-identifier hs-var">move</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Int] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`notElem`</span></span><span> </span><span class="annot"><span class="annottext">Board -&gt; [Int]
</span><a href="GameLogics.html#legalMoves"><span class="hs-identifier hs-var">legalMoves</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Position -&gt; Board
</span><a href="GameLogics.html#board"><span class="hs-identifier hs-var hs-var">board</span></a></span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679059147"><span class="hs-identifier hs-var">pos</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span>                </span><span class="hs-keyword">then</span><span>
</span><span id="line-79"></span><span>                    </span><span class="annot"><span class="annottext">IO () -&gt; StateT Position IO ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Handle -&gt; String -&gt; IO ()
</span><span class="hs-identifier hs-var">hPutStrLn</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059141"><span class="hs-identifier hs-var">hdl</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Not legal move!&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StateT Position IO ()
-&gt; StateT Position IO () -&gt; StateT Position IO ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Chan Msg -&gt; (Player -&gt; Handle) -&gt; StateT Position IO ()
</span><a href="Server.html#gameIteration"><span class="hs-identifier hs-var">gameIteration</span></a></span><span> </span><span class="annot"><span class="annottext">Chan Msg
</span><a href="#local-6989586621679059149"><span class="hs-identifier hs-var">chan</span></a></span><span> </span><span class="annot"><span class="annottext">Player -&gt; Handle
</span><a href="#local-6989586621679059148"><span class="hs-identifier hs-var">h4p</span></a></span><span>
</span><span id="line-80"></span><span>                </span><span class="hs-keyword">else</span><span>
</span><span id="line-81"></span><span>                    </span><span class="annot"><span class="annottext">(Position -&gt; Position) -&gt; StateT Position IO ()
forall (m :: * -&gt; *) s. Monad m =&gt; (s -&gt; s) -&gt; StateT s m ()
</span><span class="hs-identifier hs-var">modify'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Position -&gt; Position
</span><a href="GameLogics.html#makeMove"><span class="hs-identifier hs-var">makeMove</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679059143"><span class="hs-identifier hs-var">move</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span>
</span><span id="line-83"></span><span class="annot"><a href="Server.html#runClient"><span class="hs-identifier hs-type">runClient</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GameLogics.html#Player"><span class="hs-identifier hs-type">Player</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Chan</span></span><span> </span><span class="annot"><a href="Server.html#Msg"><span class="hs-identifier hs-type">Msg</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span id="runClient"><span class="annot"><span class="annottext">runClient :: Handle -&gt; Player -&gt; Chan Msg -&gt; IO ()
</span><a href="Server.html#runClient"><span class="hs-identifier hs-var hs-var">runClient</span></a></span></span><span> </span><span id="local-6989586621679059135"><span class="annot"><span class="annottext">hdl :: Handle
</span><a href="#local-6989586621679059135"><span class="hs-identifier hs-var">hdl</span></a></span></span><span> </span><span id="local-6989586621679059134"><span class="annot"><span class="annottext">p :: Player
</span><a href="#local-6989586621679059134"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679059133"><span class="annot"><span class="annottext">chan :: Chan Msg
</span><a href="#local-6989586621679059133"><span class="hs-identifier hs-var">chan</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-85"></span><span>    </span><span class="annot"><span class="annottext">Handle -&gt; Player -&gt; IO ()
forall a. Show a =&gt; Handle -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">hPrint</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059135"><span class="hs-identifier hs-var">hdl</span></a></span><span> </span><span class="annot"><span class="annottext">Player
</span><a href="#local-6989586621679059134"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-86"></span><span>    </span><span class="annot"><span class="annottext">(SomeException -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall e a. Exception e =&gt; (e -&gt; IO a) -&gt; IO a -&gt; IO a
</span><span class="hs-identifier hs-var">handle</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO ()
forall a. (a -&gt; a) -&gt; a
</span><span class="hs-identifier hs-var">fix</span></span><span> </span><span class="annot"><span class="annottext">((IO () -&gt; IO ()) -&gt; IO ()) -&gt; (IO () -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679059130"><span class="annot"><span class="annottext">loop :: IO ()
</span><a href="#local-6989586621679059130"><span class="hs-identifier hs-var">loop</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-87"></span><span>        </span><span id="local-6989586621679059129"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679059129"><span class="hs-identifier hs-var">line</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Handle -&gt; IO String
</span><span class="hs-identifier hs-var">hGetLine</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059135"><span class="hs-identifier hs-var">hdl</span></a></span><span>
</span><span id="line-88"></span><span>        </span><span class="annot"><span class="annottext">Chan Msg -&gt; Msg -&gt; IO ()
forall a. Chan a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeChan</span></span><span> </span><span class="annot"><span class="annottext">Chan Msg
</span><a href="#local-6989586621679059133"><span class="hs-identifier hs-var">chan</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Player
</span><a href="#local-6989586621679059134"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679059129"><span class="hs-identifier hs-var">line</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span>        </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679059130"><span class="hs-identifier hs-var">loop</span></a></span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span class="annot"><a href="Server.html#getHandle"><span class="hs-identifier hs-type">getHandle</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span>
</span><span id="line-92"></span><span id="getHandle"><span class="annot"><span class="annottext">getHandle :: Socket -&gt; IO Handle
</span><a href="Server.html#getHandle"><span class="hs-identifier hs-var hs-var">getHandle</span></a></span></span><span> </span><span id="local-6989586621679059126"><span class="annot"><span class="annottext">sock :: Socket
</span><a href="#local-6989586621679059126"><span class="hs-identifier hs-var">sock</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-93"></span><span>    </span><span id="local-6989586621679059125"><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059125"><span class="hs-identifier hs-var">hdl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Socket -&gt; IOMode -&gt; IO Handle
</span><span class="hs-identifier hs-var">socketToHandle</span></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679059126"><span class="hs-identifier hs-var">sock</span></a></span><span> </span><span class="annot"><span class="annottext">IOMode
</span><span class="hs-identifier hs-var">ReadWriteMode</span></span><span>
</span><span id="line-94"></span><span>    </span><span class="annot"><span class="annottext">Handle -&gt; BufferMode -&gt; IO ()
</span><span class="hs-identifier hs-var">hSetBuffering</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059125"><span class="hs-identifier hs-var">hdl</span></a></span><span> </span><span class="annot"><span class="annottext">BufferMode
</span><span class="hs-identifier hs-var">NoBuffering</span></span><span>
</span><span id="line-95"></span><span>    </span><span class="annot"><span class="annottext">Handle -&gt; IO Handle
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059125"><span class="hs-identifier hs-var">hdl</span></a></span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span class="annot"><a href="Server.html#handleForPlayer"><span class="hs-identifier hs-type">handleForPlayer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GameLogics.html#Player"><span class="hs-identifier hs-type">Player</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GameLogics.html#Player"><span class="hs-identifier hs-type">Player</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span>
</span><span id="line-98"></span><span id="handleForPlayer"><span class="annot"><span class="annottext">handleForPlayer :: [(Player, Handle)] -&gt; Player -&gt; Handle
</span><a href="Server.html#handleForPlayer"><span class="hs-identifier hs-var hs-var">handleForPlayer</span></a></span></span><span> </span><span id="local-6989586621679059120"><span class="annot"><span class="annottext">hdlsMap :: [(Player, Handle)]
</span><a href="#local-6989586621679059120"><span class="hs-identifier hs-var">hdlsMap</span></a></span></span><span> </span><span id="local-6989586621679059119"><span class="annot"><span class="annottext">p :: Player
</span><a href="#local-6989586621679059119"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Player, Handle) -&gt; Handle
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">((Player, Handle) -&gt; Handle) -&gt; (Player, Handle) -&gt; Handle
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Player, Handle)] -&gt; (Player, Handle)
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">head</span></span><span> </span><span class="annot"><span class="annottext">([(Player, Handle)] -&gt; (Player, Handle))
-&gt; [(Player, Handle)] -&gt; (Player, Handle)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Player, Handle) -&gt; Bool)
-&gt; [(Player, Handle)] -&gt; [(Player, Handle)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Player -&gt; Player -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Player
</span><a href="#local-6989586621679059119"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Player -&gt; Bool)
-&gt; ((Player, Handle) -&gt; Player) -&gt; (Player, Handle) -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Player, Handle) -&gt; Player
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Player, Handle)]
</span><a href="#local-6989586621679059120"><span class="hs-identifier hs-var">hdlsMap</span></a></span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span class="annot"><a href="Server.html#tellWin"><span class="hs-identifier hs-type">tellWin</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GameLogics.html#Player"><span class="hs-identifier hs-type">Player</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GameLogics.html#Player"><span class="hs-identifier hs-type">Player</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GameLogics.html#Position"><span class="hs-identifier hs-type">Position</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span id="tellWin"><span class="annot"><span class="annottext">tellWin :: Player -&gt; (Player -&gt; Handle) -&gt; Position -&gt; IO ()
</span><a href="Server.html#tellWin"><span class="hs-identifier hs-var hs-var">tellWin</span></a></span></span><span> </span><span id="local-6989586621679059117"><span class="annot"><span class="annottext">p :: Player
</span><a href="#local-6989586621679059117"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679059116"><span class="annot"><span class="annottext">h4p :: Player -&gt; Handle
</span><a href="#local-6989586621679059116"><span class="hs-identifier hs-var">h4p</span></a></span></span><span> </span><span id="local-6989586621679059115"><span class="annot"><span class="annottext">pos :: Position
</span><a href="#local-6989586621679059115"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-102"></span><span>    </span><span class="annot"><span class="annottext">(Player -&gt; Handle) -&gt; String -&gt; IO ()
</span><a href="Server.html#tellAll"><span class="hs-identifier hs-var">tellAll</span></a></span><span> </span><span class="annot"><span class="annottext">Player -&gt; Handle
</span><a href="#local-6989586621679059116"><span class="hs-identifier hs-var">h4p</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Position -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679059115"><span class="hs-identifier hs-var">pos</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-103"></span><span>    </span><span class="annot"><span class="annottext">(Player -&gt; Handle) -&gt; String -&gt; IO ()
</span><a href="Server.html#tellAll"><span class="hs-identifier hs-var">tellAll</span></a></span><span> </span><span class="annot"><span class="annottext">Player -&gt; Handle
</span><a href="#local-6989586621679059116"><span class="hs-identifier hs-var">h4p</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Player
</span><a href="#local-6989586621679059117"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Player -&gt; Player -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Player
</span><a href="GameLogics.html#R"><span class="hs-identifier hs-var">R</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-string">&quot;Red&quot;</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-string">&quot;Yellow&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="hs-string">&quot; wins\n&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="annot"><a href="Server.html#tellDraw"><span class="hs-identifier hs-type">tellDraw</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GameLogics.html#Player"><span class="hs-identifier hs-type">Player</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GameLogics.html#Position"><span class="hs-identifier hs-type">Position</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span id="tellDraw"><span class="annot"><span class="annottext">tellDraw :: (Player -&gt; Handle) -&gt; Position -&gt; IO ()
</span><a href="Server.html#tellDraw"><span class="hs-identifier hs-var hs-var">tellDraw</span></a></span></span><span> </span><span id="local-6989586621679059112"><span class="annot"><span class="annottext">h4p :: Player -&gt; Handle
</span><a href="#local-6989586621679059112"><span class="hs-identifier hs-var">h4p</span></a></span></span><span> </span><span id="local-6989586621679059111"><span class="annot"><span class="annottext">pos :: Position
</span><a href="#local-6989586621679059111"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-107"></span><span>    </span><span class="annot"><span class="annottext">(Player -&gt; Handle) -&gt; String -&gt; IO ()
</span><a href="Server.html#tellAll"><span class="hs-identifier hs-var">tellAll</span></a></span><span> </span><span class="annot"><span class="annottext">Player -&gt; Handle
</span><a href="#local-6989586621679059112"><span class="hs-identifier hs-var">h4p</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Position -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679059111"><span class="hs-identifier hs-var">pos</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span>    </span><span class="annot"><span class="annottext">(Player -&gt; Handle) -&gt; String -&gt; IO ()
</span><a href="Server.html#tellAll"><span class="hs-identifier hs-var">tellAll</span></a></span><span> </span><span class="annot"><span class="annottext">Player -&gt; Handle
</span><a href="#local-6989586621679059112"><span class="hs-identifier hs-var">h4p</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Draw&quot;</span></span><span>
</span><span id="line-109"></span><span>
</span><span id="line-110"></span><span class="annot"><a href="Server.html#tellAll"><span class="hs-identifier hs-type">tellAll</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GameLogics.html#Player"><span class="hs-identifier hs-type">Player</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span id="tellAll"><span class="annot"><span class="annottext">tellAll :: (Player -&gt; Handle) -&gt; String -&gt; IO ()
</span><a href="Server.html#tellAll"><span class="hs-identifier hs-var hs-var">tellAll</span></a></span></span><span> </span><span id="local-6989586621679059110"><span class="annot"><span class="annottext">h4p :: Player -&gt; Handle
</span><a href="#local-6989586621679059110"><span class="hs-identifier hs-var">h4p</span></a></span></span><span> </span><span id="local-6989586621679059109"><span class="annot"><span class="annottext">msg :: String
</span><a href="#local-6989586621679059109"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-112"></span><span>    </span><span class="annot"><span class="annottext">Handle -&gt; String -&gt; IO ()
</span><span class="hs-identifier hs-var">hPutStrLn</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Player -&gt; Handle
</span><a href="#local-6989586621679059110"><span class="hs-identifier hs-var">h4p</span></a></span><span> </span><span class="annot"><span class="annottext">Player
</span><a href="GameLogics.html#R"><span class="hs-identifier hs-var">R</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679059109"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-113"></span><span>    </span><span class="annot"><span class="annottext">Handle -&gt; String -&gt; IO ()
</span><span class="hs-identifier hs-var">hPutStrLn</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Player -&gt; Handle
</span><a href="#local-6989586621679059110"><span class="hs-identifier hs-var">h4p</span></a></span><span> </span><span class="annot"><span class="annottext">Player
</span><a href="GameLogics.html#Y"><span class="hs-identifier hs-var">Y</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679059109"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-114"></span></pre></body></html>